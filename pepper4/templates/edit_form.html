{% extends "base.html" %} 
{% block title %}Edit Form - Google Forms Clone{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12 col-lg-12 col-xl-12 mx-auto">
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div>
                <h3>{{ form.title }}</h3>
                <p class="text-muted mb-0">{{ form.description or 'No description' }}</p>
                </div>
                <div>
                    <form action="{{ url_for('toggle_form_status', form_id=form.id) }}" method="POST" class="d-inline">
                        <button type="submit" class="btn {% if form.is_closed %}btn-success{% else %}btn-warning{% endif %}" title="{% if form.is_closed %}Reopen Form{% else %}Close Form{% endif %}">
                            {% if form.is_closed %}
                            <i class="bi bi-unlock"></i> Reopen Form
                            {% else %}
                            <i class="bi bi-lock"></i> Close Form
                            {% endif %}
                        </button>
                    </form>
                </div>
            </div>
            <div class="card-body">
                {% if form.is_closed %}
                <div class="alert alert-warning mb-3">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i> This form is currently closed and not accepting new responses.
                </div>
                {% endif %}
                
                <div class="mb-3">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="requires_consent" {% if form.requires_consent %}checked{% endif %}>
                        <label class="form-check-label" for="requires_consent">Require privacy policy and terms consent</label>
                    </div>
                </div>
                
                <!-- Quiz Settings -->
                <div class="card mb-3">
                    <div class="card-header">
                        <h4 class="mb-0">Quiz Settings</h4>
                    </div>
                    <div class="card-body">
                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" id="is_quiz" {% if form.is_quiz %}checked{% endif %}>
                            <label class="form-check-label" for="is_quiz">Enable Quiz Mode</label>
                        </div>
                        
                        <div id="quiz-settings" class="{% if not form.is_quiz %}d-none{% endif %}">
                            <div class="mb-3">
                                <label for="passing_score" class="form-label">Passing Score (%)</label>
                                <input type="number" class="form-control" id="passing_score" min="0" max="100" value="{{ form.passing_score or 70 }}">
                            </div>
                            
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="show_score" {% if form.show_score %}checked{% endif %}>
                                <label class="form-check-label" for="show_score">Show Score to Respondents</label>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="questions-container">
                    {% for question in form.questions %}
                    <div class="question-card card mb-3" data-question-id="{{ question.id }}">
                        <div class="card-body">
                            <!-- Question text input -->
                            <div class="d-flex justify-content-between align-items-start mb-3">
                                <input type="text" class="form-control form-control-lg question-text" 
                                       value="{{ question.question_text }}" 
                                       placeholder="Question text" 
                                       aria-label="Question text">
                                <button class="btn btn-outline-danger ms-2 delete-question" 
                                        title="Delete question">
                                    <i class="bi bi-trash" aria-hidden="true"></i>
                                    <span class="visually-hidden">Delete question</span>
                                </button>
                            </div>

                            <!-- Select question type -->
                            <div class="mb-3">
                                <select class="form-select question-type" aria-label="Question type" title="Select question type">
                                    <option value="text" {% if question.question_type == 'text' %}selected{% endif %}>Text</option>
                                    <option value="password" {% if question.question_type == 'password' %}selected{% endif %}>Password</option>
                                    <option value="email" {% if question.question_type == 'email' %}selected{% endif %}>Email</option>
                                    <option value="number" {% if question.question_type == 'number' %}selected{% endif %}>Number</option>
                                    <option value="tel" {% if question.question_type == 'tel' %}selected{% endif %}>Telephone</option>
                                    <option value="url" {% if question.question_type == 'url' %}selected{% endif %}>URL</option>
                                    <option value="search" {% if question.question_type == 'search' %}selected{% endif %}>Search</option>
                                    <option value="date" {% if question.question_type == 'date' %}selected{% endif %}>Date</option>
                                    <option value="datetime-local" {% if question.question_type == 'datetime-local' %}selected{% endif %}>Datetime</option>
                                    <option value="month" {% if question.question_type == 'month' %}selected{% endif %}>Month</option>
                                    <option value="week" {% if question.question_type == 'week' %}selected{% endif %}>Week</option>
                                    <option value="time" {% if question.question_type == 'time' %}selected{% endif %}>Time</option>
                                    <option value="color" {% if question.question_type == 'color' %}selected{% endif %}>Color</option>
                                    <option value="file" {% if question.question_type == 'file' %}selected{% endif %}>File</option>
                                    <option value="checkbox" {% if question.question_type == 'checkbox' %}selected{% endif %}>Checkbox</option>
                                    <option value="radio" {% if question.question_type in ['radio','multiple_choice'] %}selected{% endif %}>Radio/Multiple Choice</option>
                                    <option value="range" {% if question.question_type == 'range' %}selected{% endif %}>Range</option>
                                    <option value="hidden" {% if question.question_type == 'hidden' %}selected{% endif %}>Hidden</option>
                                    <option value="image" {% if question.question_type == 'image' %}selected{% endif %}>Image</option>
                                    <option value="scale" {% if question.question_type == 'scale' %}selected{% endif %}>Scale (Likert)</option>
                                    <option value="matrix" {% if question.question_type == 'matrix' %}selected{% endif %}>Matrix</option>
                                </select>
                            </div>

                            <!-- Updated Options container with sub-questions -->
                            <div class="options-container mb-3">
                                {% if question.question_type in ['radio','multiple_choice'] %}
                                    {% set opts = question.options|fromjson if question.options else [] %}
                                    {% for opt in opts %}
                                    <div class="option-group mb-2">
                                        <div class="d-flex align-items-center">
                                            <input type="text" class="form-control option-text me-2"
                                                   value="{{ opt.text }}" 
                                                   placeholder="Option text">
                                            <button class="btn btn-outline-danger delete-option me-2" title="Delete option">
                                                <i class="bi bi-x"></i>
                                            </button>
                                            <button class="btn btn-outline-secondary add-subquestion" title="Add sub-question">
                                                Add Sub-question
                                            </button>
                                        </div>
                                        
                                        <!-- Option Media Type -->
                                        <div class="mt-2 option-media-container">
                                            <div class="btn-group" role="group">
                                                <input type="radio" class="btn-check option-media-type" name="media-type-{{ question.id }}-{{ loop.index }}" 
                                                      id="media-none-{{ question.id }}-{{ loop.index }}" value="none" 
                                                      {% if not opt.media_type or opt.media_type == 'none' %}checked{% endif %}>
                                                <label class="btn btn-outline-secondary" for="media-none-{{ question.id }}-{{ loop.index }}">Text Only</label>
                                              
                                                <input type="radio" class="btn-check option-media-type" name="media-type-{{ question.id }}-{{ loop.index }}" 
                                                      id="media-image-{{ question.id }}-{{ loop.index }}" value="image"
                                                      {% if opt.media_type == 'image' %}checked{% endif %}>
                                                <label class="btn btn-outline-secondary" for="media-image-{{ question.id }}-{{ loop.index }}">Image</label>
                                              
                                                <input type="radio" class="btn-check option-media-type" name="media-type-{{ question.id }}-{{ loop.index }}" 
                                                      id="media-gif-{{ question.id }}-{{ loop.index }}" value="gif"
                                                      {% if opt.media_type == 'gif' %}checked{% endif %}>
                                                <label class="btn btn-outline-secondary" for="media-gif-{{ question.id }}-{{ loop.index }}">GIF</label>
                                            </div>
                                            
                                            <!-- Media Upload Container (initially hidden) -->
                                            <div class="option-media-upload-container mt-2 {% if not opt.media_type or opt.media_type == 'none' %}d-none{% endif %}">
                                                <div class="mb-2">
                                                    <input type="file" class="form-control option-media-upload" accept="image/*,.gif" style="display: none;">
                                                    <button type="button" class="btn btn-outline-secondary option-media-upload-btn">
                                                        <i class="bi bi-upload"></i> Upload Image/GIF
                                                    </button>
                                                </div>
                                                
                                                <!-- Media URL -->
                                                <div class="mb-2">
                                                    <input type="url" class="form-control option-media-url" 
                                                           placeholder="Enter URL for the image/GIF (optional)"
                                                           value="{{ opt.media_url or '' }}">
                                                    <small class="form-text text-muted">If provided, clicking the image will redirect to this URL</small>
                                                </div>
                                                
                                                <!-- Media Description -->
                                                <div class="mb-2">
                                                    <textarea class="form-control option-media-description" 
                                                              placeholder="Enter description for the image/GIF"
                                                              rows="2">{{ opt.media_description or '' }}</textarea>
                                                </div>
                                                
                                                <!-- Media Preview -->
                                                {% if opt.media_url %}
                                                <div class="mt-2 option-media-preview">
                                                    <img src="{{ opt.media_url }}" alt="Option media" class="img-thumbnail" style="max-height: 100px;">
                                                    <button type="button" class="btn btn-sm btn-outline-danger option-media-remove-btn">
                                                        <i class="bi bi-x"></i> Remove
                                                    </button>
                                                </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                        
                                        {% if 'subquestions' in opt and opt.subquestions %}
                                        <div class="subquestions-container ps-4 mt-2">
                                                {% for sub in opt.subquestions %}
                                                <div class="subquestion-card card mb-2">
                                                    <div class="card-body">
                                                        <div class="d-flex align-items-center mb-2">
                                                            <input type="text" class="form-control subquestion-text me-2"
                                                                   value="{{ sub.text }}" 
                                                                   placeholder="Sub-question text">
                                                            <select class="form-select subquestion-type me-2" 
                                                                style="max-width: 150px;" title="Select sub-question type">
                                                                {% for type in ['text', 'number', 'email', 'date', 'radio', 'checkbox', 'file', 'password'] %}
                                                                <option value="{{ type }}" 
                                                                        {% if sub.type == type %}selected{% endif %}>
                                                                    {{ type|title }}
                                                                </option>
                                                                {% endfor %}
                                                            </select>
                                                        <button class="btn btn-outline-danger delete-subquestion" title="Delete sub-question">
                                                                <i class="bi bi-x"></i>
                                                            </button>
                                                        </div>
                                                        
                                                        <div class="subquestion-response mt-2">
                                                            {% if sub.type in ['radio', 'checkbox'] and sub.options %}
                                                                {% for option in sub.options %}
                                                                <div class="response-option-group">
                                                                    <div class="response-option input-group mb-1">
                                                                        <input type="text" class="form-control" value="{{ option.text }}" placeholder="Option text">
                                                                    <button class="btn btn-outline-danger delete-response-option" title="Delete option">
                                                                            <i class="bi bi-x"></i>
                                                                        </button>
                                                                    <button class="btn btn-outline-secondary add-nested-subquestion" title="Add nested question">
                                                                            <i class="bi bi-plus-circle"></i>
                                                                        </button>
                                                                    </div>
                                                                    <div class="nested-subquestions-container ps-4 mt-1">
                                                                        {% if option.subquestions %}
                                                                            {% for nested_sub in option.subquestions %}
                                                                            <div class="nested-subquestion-card card mb-2">
                                                                                <div class="card-body">
                                                                                    <div class="d-flex align-items-center mb-2">
                                                                                        <input type="text" class="form-control nested-subquestion-text me-2"
                                                                                               value="{{ nested_sub.text }}" 
                                                                                               placeholder="Nested question text">
                                                                                        <select class="form-select nested-subquestion-type me-2" 
                                                                                            style="max-width: 130px;" title="Select question type">
                                                                                            {% for type in ['text', 'number', 'email', 'date', 'radio', 'checkbox', 'file', 'password'] %}
                                                                                            <option value="{{ type }}" 
                                                                                                    {% if nested_sub.type == type %}selected{% endif %}>
                                                                                                {{ type|title }}
                                                                                            </option>
                                                                                            {% endfor %}
                                                                                        </select>
                                                                                    <button class="btn btn-outline-danger delete-nested-subquestion" title="Delete nested question">
                                                                                            <i class="bi bi-x"></i>
                                                                                        </button>
                                                                                    </div>
                                                                                    <div class="nested-subquestion-response mt-2">
                                                                                        <!-- Nested response options would render here -->
                                                                                    </div>
                                                                                </div>
                                                                            </div>
                                                                            {% endfor %}
                                                                        {% endif %}
                                                                    </div>
                                                                </div>
                                                                {% endfor %}
                                                            <button type="button" class="btn btn-sm btn-outline-secondary add-response-option mt-1" title="Add response option">Add Option</button>
                                                            {% endif %}
                                                        </div>
                                                    </div>
                                                </div>
                                                {% endfor %}
                                        </div>
                                            {% endif %}
                                    </div>
                                    {% endfor %}
                                    <button class="btn btn-outline-secondary btn-sm add-option">
                                        <i class="bi bi-plus"></i> Add Option
                                    </button>
                                {% endif %}
                            </div>

                            <!-- Required checkbox -->
                            <div class="form-check mt-3">
                                <input class="form-check-input question-required" type="checkbox"
                                       {% if question.required %}checked{% endif %} 
                                       id="required-{{ question.id }}">
                                <label class="form-check-label" for="required-{{ question.id }}">Required</label>
                            </div>

                            <!-- Quiz Question Settings -->
                            <div class="quiz-settings-section mt-3 {% if not form.is_quiz %}d-none{% endif %}">
                                <div class="card bg-light">
                                    <div class="card-header">
                                        <div class="form-check">
                                            <input class="form-check-input is-quiz-question" type="checkbox"
                                                {% if question.is_quiz_question %}checked{% endif %}
                                                id="quiz-{{ question.id }}">
                                            <label class="form-check-label" for="quiz-{{ question.id }}">
                                                <strong>Quiz Question</strong>
                                            </label>
                        </div>
                    </div>
                                    <div class="card-body quiz-question-details {% if not question.is_quiz_question %}d-none{% endif %}">
                                        <!-- Points field -->
                                        <div class="mb-3">
                                            <label for="points-{{ question.id }}" class="form-label">Points</label>
                                            <input type="number" class="form-control question-points" 
                                                id="points-{{ question.id }}" min="0" 
                                                value="{{ question.points or 1 }}">
                                        </div>
                                        
                                        <!-- Correct Answer field (depends on question type) -->
                                        <div class="mb-3 correct-answer-container">
                                            <label for="correct-answer-{{ question.id }}" class="form-label">Correct Answer</label>
                                            {% if question.question_type in ['text', 'number', 'email', 'password', 'tel', 'url'] %}
                                                <input type="text" class="form-control correct-answer" 
                                                    id="correct-answer-{{ question.id }}" 
                                                    value="{{ question.correct_answer|fromjson if question.correct_answer else '' }}">
                                            {% elif question.question_type in ['radio', 'multiple_choice'] %}
                                                <select class="form-select correct-answer" 
                                                        id="correct-answer-{{ question.id }}"
                                                        title="Select correct option">
                                                    <option value="">Select correct option</option>
                                                    {% if question.options %}
                                                        {% set opts = question.options|fromjson %}
                                                        {% for opt in opts %}
                                                            <option value="{{ loop.index0 }}" 
                                                                {% if question.correct_answer and (question.correct_answer|fromjson) == loop.index0|string %}selected{% endif %}>
                                                                {{ opt.text }}
                                                            </option>
                                                        {% endfor %}
                                                    {% endif %}
                                                </select>
                                            {% endif %}
                                        </div>
                                        
                                        <!-- Feedback field -->
                                        <div class="mb-3">
                                            <label for="feedback-{{ question.id }}" class="form-label">Feedback</label>
                                            <textarea class="form-control question-feedback" 
                                                id="feedback-{{ question.id }}" rows="2">{{ question.feedback or '' }}</textarea>
                                            <small class="form-text text-muted">
                                                Feedback shown to users after answering this question
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Add this in the question template -->
                            <div class="form-group">
                                <label>Question Media (Optional)</label>
                                <div class="media-upload-container">
                                    <input type="file" class="form-control media-upload" accept="image/*,.gif" style="display: none;">
                                    <button type="button" class="btn btn-outline-secondary media-upload-btn">
                                        <i class="fas fa-image"></i> Upload Image/GIF
                                    </button>
                                    <img class="media-preview" src="" alt="Preview">
                                    <span class="media-remove-btn" style="display: none;">
                                        <i class="fas fa-times"></i> Remove
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                
                <button id="add-question" class="btn btn-outline-primary w-100 mb-3">
                    <i class="bi bi-plus-lg" aria-hidden="true"></i> Add Question
                </button>
                
                <div class="d-flex justify-content-between">
                    <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary">Back to Dashboard</a>
                    <button id="save-form" class="btn btn-primary">Save Form</button>
                </div>

                <!-- <label for="active_from">Active From:</label>
                <input type="datetime-local" name="active_from" id="active_from" required>


                <label for="active_to">Active To:</label>
                <input type="datetime-local" name="active_to" id="active_to" required>

                <label for="timezone">Timezone:</label>
                <select name="timezone" id="timezone">
                  {% for tz in all_timezones %}
                    <option value="{{ tz }}">{{ tz }}</option>
                  {% endfor %}
                </select> -->

                <div class="mb-3">
                    <label for="redirect_links" class="form-label">External Redirect Links (one per line)</label>
                    <textarea class="form-control" id="redirect_links" name="redirect_links" rows="3">{% if form.redirect_links %}{{ form.redirect_links | fromjson | join('\n') }}{% endif %}</textarea>
                    <small class="form-text text-muted">These links will be used for redirection if the form is not active. One link per line.</small>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
<style>
    .subquestion-card { 
        background-color: #f8f9fa; 
        border-left: 3px solid #dee2e6; 
        margin-left: 1rem; 
    }
    .nested-subquestion-card {
        background-color: #eff1f3;
        border-left: 3px solid #adb5bd;
        margin-left: 0.5rem;
    }
    .card-body { 
        padding: 0.75rem; 
    }
    .nested-subquestion-card .card-body {
        padding: 0.5rem;
    }
    .input-group {
        margin-bottom: 0.5rem !important;
    }
    .option-group {
        border-left: 3px solid #e9ecef;
        padding-left: 0.75rem;
    }
    .option-group:hover {
        border-left-color: #6c757d;
    }
    .subquestions-container,
    .nested-subquestions-container {
        transition: all 0.3s ease;
    }
    .add-nested-subquestion {
        font-size: 0.8rem;
        padding: 0.25rem 0.5rem;
    }
    .response-option-group {
        position: relative;
    }
    .depth-indicator {
        position: absolute;
        left: -15px;
        top: 50%;
        height: 100%;
        border-left: 2px dotted #dee2e6;
    }
    .form-nesting-level-indicator {
        font-size: 12px;
        color: #6c757d;
        margin-bottom: 5px;
    }
    .media-preview {
        max-width: 200px;
        max-height: 200px;
        margin: 10px 0;
        border-radius: 4px;
        display: none;
    }
    .media-upload-btn {
        margin: 5px 0;
    }
    .media-remove-btn {
        margin-left: 10px;
        color: #dc3545;
        cursor: pointer;
    }
</style>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const qc = document.getElementById('questions-container');
    const addQuestionBtn = document.getElementById('add-question');
    const saveFormBtn = document.getElementById('save-form');
    const formId = "{{ form.id }}";
    const isQuizCheckbox = document.getElementById('is_quiz');
    const quizSettingsDiv = document.getElementById('quiz-settings');
    
    // Max nesting level (to prevent infinite nesting and performance issues)
    const MAX_NESTING_LEVEL = 3;
    
    // Toggle quiz settings visibility based on checkbox
    isQuizCheckbox.addEventListener('change', (e) => {
      if (e.target.checked) {
        quizSettingsDiv.classList.remove('d-none');
        document.querySelectorAll('.quiz-settings-section').forEach(el => {
          el.classList.remove('d-none');
        });
      } else {
        quizSettingsDiv.classList.add('d-none');
        document.querySelectorAll('.quiz-settings-section').forEach(el => {
          el.classList.add('d-none');
        });
      }
    });
    
    // Handle quiz question checkbox toggle
    qc.addEventListener('change', (e) => {
      if (e.target.classList.contains('is-quiz-question')) {
        const card = e.target.closest('.card');
        const detailsDiv = card.querySelector('.quiz-question-details');
        if (e.target.checked) {
          detailsDiv.classList.remove('d-none');
        } else {
          detailsDiv.classList.add('d-none');
        }
      }
    });
  
    // 1) Add new question
    addQuestionBtn.onclick = () => qc.appendChild(createQuestionCard());
  
    // 2) Show/hide options when question type changes
    qc.addEventListener('change', e => {
      if (e.target.classList.contains('question-type')) {
        const card = e.target.closest('.card-body');
        showOrHideOptionFields(card, e.target.value);
      }
  
      // Sub-question type selected → render appropriate input(s)
      if (e.target.classList.contains('subquestion-type')) {
        const subCard = e.target.closest('.subquestion-card');
        renderSubquestionResponse(subCard, e.target.value);
      }
      
      // Nested sub-question type selected → render appropriate input(s)
      if (e.target.classList.contains('nested-subquestion-type')) {
        const nestedSubCard = e.target.closest('.nested-subquestion-card');
        renderNestedSubquestionResponse(nestedSubCard, e.target.value);
      }
    });
  
    // 3) Handle all clicks: delete, add option, add sub-question, add response-option, etc.
    qc.addEventListener('click', e => {
      // Delete handlers
      if (e.target.closest('.delete-question')) {
        if (confirm('Are you sure you want to delete this question?')) {
          e.target.closest('.question-card').remove();
        }
      }
      else if (e.target.closest('.delete-option')) {
        if (confirm('Delete this option and all its sub-questions?')) {
          e.target.closest('.option-group').remove();
        }
      }
      else if (e.target.closest('.delete-subquestion')) {
        if (confirm('Delete this sub-question and any nested questions?')) {
          e.target.closest('.subquestion-card').remove();
        }
      }
      else if (e.target.closest('.delete-nested-subquestion')) {
        e.target.closest('.nested-subquestion-card').remove();
      }
      else if (e.target.closest('.delete-response-option')) {
        const responseOption = e.target.closest('.response-option-group');
        if (responseOption) {
          // If it has a nested-subquestions container with children, confirm
          const nestedContainer = responseOption.querySelector('.nested-subquestions-container');
          if (nestedContainer && nestedContainer.children.length > 0) {
            if (confirm('Delete this option and its nested questions?')) {
              responseOption.remove();
            }
          } else {
            responseOption.remove();
          }
        } else {
          // Legacy support for older format
          e.target.closest('.response-option').remove();
        }
      }
      
      // Add handlers
      else if (e.target.closest('.add-option')) {
        const opts = e.target.closest('.options-container');
        opts.insertBefore(createOptionGroup(), e.target);
      }
      else if (e.target.closest('.add-subquestion')) {
        const optionGroup = e.target.closest('.option-group');
        const subContainer = optionGroup.querySelector('.subquestions-container');
        subContainer.appendChild(createSubquestionInput());
      }
      else if (e.target.closest('.add-response-option')) {
        const resp = e.target.closest('.subquestion-response');
        resp.insertBefore(createResponseOptionGroup(), e.target);
      }
      else if (e.target.closest('.add-nested-subquestion')) {
        const responseOptionGroup = e.target.closest('.response-option-group');
        const nestedContainer = responseOptionGroup.querySelector('.nested-subquestions-container');
        
        // Check nesting level to prevent too deep hierarchies
        const nestingLevel = countParents(responseOptionGroup, '.response-option-group') + 1;
        
        if (nestingLevel <= MAX_NESTING_LEVEL) {
          nestedContainer.appendChild(createNestedSubquestionInput());
        } else {
          alert(`Maximum nesting level (${MAX_NESTING_LEVEL}) reached. Cannot add more nested questions.`);
        }
      }
    });
  
    // 4) Save form
saveFormBtn.onclick = async () => {
  const questions = [];
  document.querySelectorAll('.question-card').forEach((card, i) => {
    const questionType = card.querySelector('.question-type').value;
    const data = {
      id: card.dataset.questionId || null,
      question_text: card.querySelector('.question-text').value.trim(),
      question_type: questionType,
      required: card.querySelector('.question-required').checked,
      order: i, 
          options: null,
          // Quiz-related fields
          is_quiz_question: card.querySelector('.is-quiz-question')?.checked || false,
          points: card.querySelector('.question-points')?.value || 0,
          feedback: card.querySelector('.question-feedback')?.value || null
        };
        
        // Get correct answer based on question type
        const correctAnswerInput = card.querySelector('.correct-answer');
        if (data.is_quiz_question && correctAnswerInput) {
          if (questionType === 'radio' || questionType === 'multiple_choice') {
            data.correct_answer = correctAnswerInput.value ? JSON.stringify(correctAnswerInput.value) : null;
          } else {
            data.correct_answer = correctAnswerInput.value ? JSON.stringify(correctAnswerInput.value) : null;
          }
        } else {
          data.correct_answer = null;
        }

    // Special handling for question types with options
    if (['radio','multiple_choice'].includes(questionType)) {
      const opts = [];
      
      // Process each option group
      card.querySelectorAll('.option-group').forEach(og => {
        const optionText = og.querySelector('.option-text').value.trim();
        if (!optionText) return; // Skip empty options
            
            // Collect media type information
            const optionMediaType = og.querySelector('.option-media-type:checked')?.value || 'none';
            const optionMediaUrl = og.querySelector('.option-media-url')?.value || '';
        
        const optionData = {
          text: optionText,
              media_type: optionMediaType,
              media_url: optionMediaUrl !== '' ? optionMediaUrl : null,
          subquestions: [] 
        };
            
            // Debug log each option data
            console.log(`Option: ${optionText}, Media type: ${optionMediaType}, URL: ${optionMediaUrl}`);
        
        // Process subquestions for this option
        og.querySelectorAll('.subquestion-card').forEach(sq => {
          const subqText = sq.querySelector('.subquestion-text').value.trim();
          if (!subqText) return; // Skip empty subquestions
          
          const subqType = sq.querySelector('.subquestion-type').value;
          const subQuestionData = { 
            text: subqText, 
            type: subqType,
            options: null
          };
          
          // Handle response options for radio/checkbox sub-questions
          if (subqType === 'radio' || subqType === 'checkbox') {
            const responseOptions = [];
            
            sq.querySelectorAll('.response-option-group').forEach(rog => {
              const optInput = rog.querySelector('.response-option input');
              if (!optInput) return; // Skip if no input found
              
              const optText = optInput.value.trim();
              if (!optText) return; // Skip empty options
              
              const responseOptData = {
                text: optText,
                subquestions: []
              };
              
              // Process nested subquestions (level 3)
              rog.querySelectorAll('.nested-subquestion-card').forEach(nsc => {
                const nestedText = nsc.querySelector('.nested-subquestion-text').value.trim();
                if (!nestedText) return; // Skip empty nested questions
                
                const nestedType = nsc.querySelector('.nested-subquestion-type').value;
                responseOptData.subquestions.push({
                  text: nestedText,
                  type: nestedType,
                  // Further nesting could be added here if needed
                });
              });
              
              responseOptions.push(responseOptData);
            });
            
            if (responseOptions.length > 0) {
              subQuestionData.options = responseOptions;
            }
          }
          
          optionData.subquestions.push(subQuestionData);
        });
        
        opts.push(optionData);
      });
      
      if (opts.length > 0) {
            // Store options as a native array of objects, not as a JSON string
            // The server will handle the conversion to JSON
            data.options = opts;
            
            // Debug log the final options
            console.log("Final option data structure:", opts);
      }
    }
    
    questions.push(data);
  });

      // Get quiz settings
      const isQuiz = document.getElementById('is_quiz').checked;
      const passingScore = document.getElementById('passing_score').value;
      const showScore = document.getElementById('show_score').checked;
      
      // Get privacy consent setting
      const requiresConsent = document.getElementById('requires_consent').checked;

      try {
        // Create submission data
        const submissionData = { 
          questions, 
          requires_consent: requiresConsent,
          is_quiz: isQuiz,
          passing_score: passingScore,
          show_score: showScore
        };
        
    // Log the data being sent for debugging
        console.log('Sending form data:', submissionData);
        
        // Add visual feedback
        const saveBtn = document.getElementById('save-form');
        const originalText = saveBtn.textContent;
        saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span> Saving...';
        saveBtn.disabled = true;
        
        // Create a status message area if it doesn't exist
        let statusArea = document.getElementById('save-status-area');
        if (!statusArea) {
          statusArea = document.createElement('div');
          statusArea.id = 'save-status-area';
          statusArea.className = 'alert mt-3';
          saveBtn.parentNode.appendChild(statusArea);
        }
        
        statusArea.className = 'alert alert-info mt-3';
        statusArea.textContent = 'Saving form...';
    
    const res = await fetch(`/form/${formId}/update`, {
      method: 'POST', 
      headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(submissionData)
    });
    
    if (res.ok) {
      const data = await res.json();
      console.log('Response:', data);
          
          statusArea.className = 'alert alert-success mt-3';
          statusArea.textContent = 'Form saved successfully! Redirecting to dashboard...';
          
          setTimeout(() => {
      window.location = '/dashboard';
          }, 1000);
    } else {
      let errorMessage = 'Unknown error';
      try {
        const errorData = await res.json();
        errorMessage = errorData.message || errorData.error || 'Unknown error';
            console.error('Error response:', errorData);
      } catch (e) {
        console.error('Error parsing error response:', e);
      }
          
          statusArea.className = 'alert alert-danger mt-3';
          statusArea.textContent = `Error saving: ${errorMessage}`;
          
          // Reset the save button
          saveBtn.innerHTML = originalText;
          saveBtn.disabled = false;
    }
  } catch (err) {
    console.error('Save error:', err);
        
        let statusArea = document.getElementById('save-status-area');
        if (!statusArea) {
          statusArea = document.createElement('div');
          statusArea.id = 'save-status-area';
          statusArea.className = 'alert mt-3';
          document.getElementById('save-form').parentNode.appendChild(statusArea);
        }
        
        statusArea.className = 'alert alert-danger mt-3';
        statusArea.textContent = `Network error while saving form: ${err.message}`;
        
        // Reset the save button
        const saveBtn = document.getElementById('save-form');
        saveBtn.innerHTML = originalText;
        saveBtn.disabled = false;
  }
};
  
    // ─── Helper Functions ──────────────────────────────────────────────────────────────
  
    // Count parent elements matching a selector to determine nesting level
    function countParents(element, selector) {
      let count = 0;
      let parent = element.parentElement;
      
      while (parent) {
        if (parent.matches(selector)) {
          count++;
        }
        parent = parent.parentElement;
      }
      
      return count;
    }
    
    function showOrHideOptionFields(cardBody, qType) {
      const oc = cardBody.querySelector('.options-container');
      oc.innerHTML = '';
      
      if (['radio','multiple_choice'].includes(qType)) {
        oc.appendChild(createOptionGroup());
        const btn = document.createElement('button');
        btn.className = 'btn btn-outline-secondary btn-sm add-option';
        btn.innerHTML = '<i class="bi bi-plus"></i> Add Option';
        oc.appendChild(btn);
      }
    }
  
    function createQuestionCard() {
      const div = document.createElement('div');
      div.className = 'question-card card mb-3';
      div.innerHTML = `
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start mb-3">
            <input type="text" class="form-control form-control-lg question-text" placeholder="Question text">
            <button class="btn btn-outline-danger ms-2 delete-question" title="Delete question">
              <i class="bi bi-trash"></i>
              <span class="visually-hidden">Delete question</span>
            </button>
          </div>
          <div class="mb-3">
            <select class="form-select question-type" title="Question type">
              <option value="text">Text</option>
              <option value="password">Password</option>
              <option value="email">Email</option>
              <option value="number">Number</option>
              <option value="tel">Telephone</option>
              <option value="url">URL</option>
              <option value="search">Search</option>
              <option value="date">Date</option>
              <option value="datetime-local">Datetime</option>
              <option value="month">Month</option>
              <option value="week">Week</option>
              <option value="time">Time</option>
              <option value="color">Color</option>
              <option value="file">File</option>
              <option value="checkbox">Checkbox</option>
              <option value="radio">Radio/Multiple Choice</option>
              <option value="range">Range</option>
              <option value="hidden">Hidden</option>
              <option value="image">Image</option>
              <option value="scale">Scale (Likert)</option>
              <option value="matrix">Matrix</option>
            </select>
          </div>
          <div class="options-container mb-3"></div>
          <div class="form-check">
            <input class="form-check-input question-required" type="checkbox" id="required-new">
            <label class="form-check-label" for="required-new">Required</label>
          </div>
          
          <!-- Quiz Question Settings for new question -->
          <div class="quiz-settings-section mt-3 ${isQuizCheckbox.checked ? '' : 'd-none'}">
            <div class="card bg-light">
              <div class="card-header">
                <div class="form-check">
                  <input class="form-check-input is-quiz-question" type="checkbox" id="quiz-new">
                  <label class="form-check-label" for="quiz-new">
                    <strong>Quiz Question</strong>
                  </label>
                </div>
              </div>
              <div class="card-body quiz-question-details d-none">
                <!-- Points field -->
                <div class="mb-3">
                  <label for="points-new" class="form-label">Points</label>
                  <input type="number" class="form-control question-points" 
                    id="points-new" min="0" value="1">
                </div>
                
                <!-- Correct Answer field (will be updated based on question type) -->
                <div class="mb-3 correct-answer-container">
                  <label for="correct-answer-new" class="form-label">Correct Answer</label>
                  <input type="text" class="form-control correct-answer" 
                    id="correct-answer-new">
                </div>
                
                <!-- Feedback field -->
                <div class="mb-3">
                  <label for="feedback-new" class="form-label">Feedback</label>
                  <textarea class="form-control question-feedback" 
                    id="feedback-new" rows="2"></textarea>
                  <small class="form-text text-muted">
                    Feedback shown to users after answering this question
                  </small>
                </div>
              </div>
            </div>
          </div>
        </div>`;
      return div;
    }
  
    function createOptionGroup() {
      const d = document.createElement('div');
      d.className = 'option-group mb-2';
      d.innerHTML = `
        <div class="d-flex align-items-center">
          <input type="text" class="form-control option-text me-2" placeholder="Option text">
          <button class="btn btn-outline-danger delete-option me-2" title="Delete option">
            <i class="bi bi-x"></i>
          </button>
                <button class="btn btn-outline-secondary add-subquestion" title="Add sub-question">
            Add Sub-question
          </button>
        </div>
            
            <!-- Option Media Type -->
            <div class="mt-2 option-media-container">
                <div class="btn-group" role="group">
                    <input type="radio" class="btn-check option-media-type" name="media-type-${Date.now()}" 
                          id="media-none-${Date.now()}" value="none" checked>
                    <label class="btn btn-outline-secondary" for="media-none-${Date.now()}">Text Only</label>
                  
                    <input type="radio" class="btn-check option-media-type" name="media-type-${Date.now()}" 
                          id="media-image-${Date.now()}" value="image">
                    <label class="btn btn-outline-secondary" for="media-image-${Date.now()}">Image</label>
                  
                    <input type="radio" class="btn-check option-media-type" name="media-type-${Date.now()}" 
                          id="media-gif-${Date.now()}" value="gif">
                    <label class="btn btn-outline-secondary" for="media-gif-${Date.now()}">GIF</label>
                </div>
                
                <!-- Media Upload Container (initially hidden) -->
                <div class="option-media-upload-container mt-2 d-none">
                    <div class="mb-2">
                        <input type="file" class="form-control option-media-upload" accept="image/*,.gif" style="display: none;">
                        <button type="button" class="btn btn-outline-secondary option-media-upload-btn">
                            <i class="bi bi-upload"></i> Upload Image/GIF
                        </button>
                    </div>
                    
                    <!-- Media URL -->
                    <div class="mb-2">
                        <input type="url" class="form-control option-media-url" 
                               placeholder="Enter URL for the image/GIF (optional)">
                        <small class="form-text text-muted">If provided, clicking the image will redirect to this URL</small>
                    </div>
                    
                    <!-- Media Description -->
                    <div class="mb-2">
                        <textarea class="form-control option-media-description" 
                                  placeholder="Enter description for the image/GIF"
                                  rows="2"></textarea>
                    </div>
                    
                    <!-- Media Preview -->
                    <div class="mt-2 option-media-preview" style="display: none;">
                        <img src="" alt="Option media" class="img-thumbnail" style="max-height: 100px;">
                        <button type="button" class="btn btn-sm btn-outline-danger option-media-remove-btn">
                            <i class="bi bi-x"></i> Remove
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Subquestions Container -->
            <div class="subquestions-container ps-4 mt-2"></div>
        `;

        // Attach event handlers
        const deleteBtn = d.querySelector('.delete-option');
        const addSubquestionBtn = d.querySelector('.add-subquestion');
        const subquestionsContainer = d.querySelector('.subquestions-container');

        if (deleteBtn) {
            deleteBtn.addEventListener('click', function(e) {
                e.preventDefault();
                if (confirm('Delete this option and all its sub-questions?')) {
                    d.remove();
                }
            });
        }

        if (addSubquestionBtn && subquestionsContainer) {
            addSubquestionBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                const subquestionCard = createSubquestionInput();
                subquestionsContainer.appendChild(subquestionCard);
            });
        }

        // Set up media type selection
        setupOptionMediaTypes(d);
        
      return d;
    }

    // Function to handle media uploads
    function handleMediaUpload(fileInput, previewImg, removeBtn, uploadBtn) {
        const file = fileInput.files[0];
        if (!file) return;

        const formData = new FormData();
        formData.append('file', file);
        
        // Get the description
        const description = fileInput.closest('.option-media-upload-container')
            .querySelector('.option-media-description').value;
        formData.append('description', description);

        // Show loading state
        uploadBtn.disabled = true;
        uploadBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Uploading...';

        fetch('/upload_media', {
            method: 'POST',
            body: formData
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                // Update the preview image
                previewImg.src = data.url;
                const previewContainer = previewImg.closest('.option-media-preview');
                previewContainer.style.display = 'block';
                removeBtn.style.display = 'inline-block';
                uploadBtn.innerHTML = '<i class="bi bi-upload"></i> Change Image/GIF';
                
                // Store the URL in a hidden input for form submission
                const mediaUrlInput = document.createElement('input');
                mediaUrlInput.type = 'hidden';
                mediaUrlInput.className = 'option-media-url';
                mediaUrlInput.value = data.url;
                previewContainer.appendChild(mediaUrlInput);

                // Add tooltip if description exists
                if (description && description.trim() !== '') {
                    previewImg.setAttribute('data-bs-toggle', 'tooltip');
                    previewImg.setAttribute('data-bs-placement', 'top');
                    previewImg.setAttribute('title', description);
                    // Initialize the tooltip
                    const tooltip = new bootstrap.Tooltip(previewImg, {
                        trigger: 'hover',
                        html: true
                    });
                } else {
                    // Remove tooltip if no description
                    previewImg.removeAttribute('data-bs-toggle');
                    previewImg.removeAttribute('data-bs-placement');
                    previewImg.removeAttribute('title');
                    const tooltip = bootstrap.Tooltip.getInstance(previewImg);
                    if (tooltip) {
                        tooltip.dispose();
                    }
                }
            } else {
                throw new Error(data.error || 'Upload failed');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error uploading file: ' + error.message);
            uploadBtn.innerHTML = '<i class="bi bi-upload"></i> Upload Image/GIF';
        })
        .finally(() => {
            uploadBtn.disabled = false;
        });
    }
  
    function createSubquestionInput() {
      const card = document.createElement('div');
      card.className = 'subquestion-card card mb-2';
      card.innerHTML = `
        <div class="card-body">
          <div class="d-flex align-items-center mb-2">
            <input type="text" class="form-control subquestion-text me-2"
                   placeholder="Sub-question text">
                    <select class="form-select subquestion-type me-2" style="max-width:150px;" title="Select sub-question type">
              <option value="text">Text</option>
              <option value="number">Number</option>
              <option value="email">Email</option>
              <option value="date">Date</option>
              <option value="radio">Radio</option>
              <option value="checkbox">Checkbox</option>
              <option value="file">File</option>
              <option value="password">Password</option>
            </select>
            <button class="btn btn-outline-danger delete-subquestion" title="Delete sub-question">
              <i class="bi bi-x"></i>
            </button>
          </div>
          <div class="subquestion-response mt-2"></div>
        </div>`;

        // Attach event handlers
        const deleteBtn = card.querySelector('.delete-subquestion');
        const typeSelect = card.querySelector('.subquestion-type');

        if (deleteBtn) {
            deleteBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                if (confirm('Delete this sub-question?')) {
                    card.remove();
                }
            });
        }

        if (typeSelect) {
            typeSelect.addEventListener('change', function() {
                renderSubquestionResponse(card, this.value);
            });
            // Initial render
            renderSubquestionResponse(card, typeSelect.value);
        }

      return card;
    }
  
    function renderSubquestionResponse(subCard, type) {
      const c = subCard.querySelector('.subquestion-response');
      c.innerHTML = '';
      
      if (['text','number','email','date','file','password'].includes(type)) {
        const inp = document.createElement('input');
        inp.type = type;
        inp.className = 'form-control';
        inp.placeholder = `Example ${type} input`;
        inp.disabled = true; // Just for display
        c.appendChild(inp);
      }
      else if (type === 'radio' || type === 'checkbox') {
            // Add two default options
        for (let i = 0; i < 2; i++) {
                const option = document.createElement('div');
                option.className = 'input-group mb-1';
                option.innerHTML = `
                    <input type="${type}" disabled>
                    <input type="text" class="form-control" placeholder="Option ${i+1}" value="Option ${i+1}">
                `;
                c.appendChild(option);
        }
        
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'btn btn-sm btn-outline-secondary add-response-option';
        btn.textContent = 'Add Option';
        c.appendChild(btn);
      }
    }
    
    // Setup media type selection and file upload
    function setupOptionMediaTypes(option) {
        const mediaTypes = option.querySelectorAll('.option-media-type');
        const mediaUploadContainer = option.querySelector('.option-media-upload-container');
        const uploadBtn = option.querySelector('.option-media-upload-btn');
        const fileInput = option.querySelector('.option-media-upload');
        const previewContainer = option.querySelector('.option-media-preview');
        const previewImg = previewContainer.querySelector('img');
        const removeBtn = previewContainer.querySelector('.option-media-remove-btn');

        // Media type selection
        mediaTypes.forEach(radio => {
            radio.addEventListener('change', function() {
                if (this.value === 'none') {
                    mediaUploadContainer.classList.add('d-none');
                } else {
                    mediaUploadContainer.classList.remove('d-none');
                }
            });
        });

        // File upload handling
        if (uploadBtn && fileInput) {
            uploadBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                fileInput.click();
            });

            fileInput.addEventListener('change', function(e) {
                e.preventDefault();
                e.stopPropagation();
                if (this.files.length > 0) {
                    handleMediaUpload(this, previewImg, removeBtn, uploadBtn);
                }
            });
        }

        // Remove button handling
        if (removeBtn) {
            removeBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                previewImg.src = '';
                previewContainer.style.display = 'none';
                removeBtn.style.display = 'none';
                uploadBtn.innerHTML = '<i class="bi bi-upload"></i> Upload Image/GIF';
                fileInput.value = '';
            });
        }
    }

    // Initialize media upload functionality for existing options
    document.addEventListener('DOMContentLoaded', function() {
        // Setup media types for existing options
        document.querySelectorAll('.option-group').forEach(setupOptionMediaTypes);

        // Setup media types for question media
        document.querySelectorAll('.media-upload-container').forEach(container => {
            const uploadBtn = container.querySelector('.media-upload-btn');
            const fileInput = container.querySelector('.media-upload');
            const previewImg = container.querySelector('.media-preview');
            const removeBtn = container.querySelector('.media-remove-btn');

            if (uploadBtn && fileInput) {
                uploadBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    fileInput.click();
                });

                fileInput.addEventListener('change', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    if (this.files.length > 0) {
                        handleMediaUpload(this, previewImg, removeBtn, uploadBtn);
                    }
                });
            }

            if (removeBtn) {
                removeBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    previewImg.src = '';
                    previewImg.style.display = 'none';
                    removeBtn.style.display = 'none';
                    uploadBtn.innerHTML = '<i class="bi bi-upload"></i> Upload Image/GIF';
                    fileInput.value = '';
                });
            }
        });

        // Initialize all tooltips
        const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltipTriggerList.forEach(function (tooltipTriggerEl) {
            new bootstrap.Tooltip(tooltipTriggerEl, {
                trigger: 'hover',
                html: true
            });
        });

        // Add event listener for description changes
        document.querySelectorAll('.option-media-description').forEach(textarea => {
            textarea.addEventListener('input', function() {
                const previewImg = this.closest('.option-media-upload-container')
                    .querySelector('.option-media-preview img');
                if (previewImg) {
                    const description = this.value.trim();
                    if (description) {
                        previewImg.setAttribute('data-bs-toggle', 'tooltip');
                        previewImg.setAttribute('data-bs-placement', 'top');
                        previewImg.setAttribute('title', description);
                        // Initialize or update the tooltip
                        const tooltip = bootstrap.Tooltip.getInstance(previewImg);
                        if (tooltip) {
                            tooltip.dispose();
                        }
                        new bootstrap.Tooltip(previewImg, {
                            trigger: 'hover',
                            html: true
                        });
                    } else {
                        // Remove tooltip if no description
                        previewImg.removeAttribute('data-bs-toggle');
                        previewImg.removeAttribute('data-bs-placement');
                        previewImg.removeAttribute('title');
                        const tooltip = bootstrap.Tooltip.getInstance(previewImg);
                        if (tooltip) {
                            tooltip.dispose();
                        }
                    }
                }
            });
        });
    });
  });
</script>
{% endblock %}
